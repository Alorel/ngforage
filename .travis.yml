sudo: false
language: node_js
node_js: 9

std_stage_name: &std_stage_name Test & Lint

stages:
  - *std_stage_name
  - name: Deploy
    if: tag IS present

cache:
  directories:
    - node_modules

std_job: &std_job
  stage: *std_stage_name
  after_success: cat ./coverage/lcov.info | coveralls
  before_install: node ./ci/TravisMgr.js set-version

npm_deploy: &npm_deploy
  stage: Deploy
  script: npm run build
  before_install: node ./ci/TravisMgr.js set-version
  deploy:
    - provider: npm
      on:
        tags: true
      skip_cleanup: true
      email: a.molcanovas@gmail.com
      api_key:
        secure: KXzzdKtu8k8my5D+ciF+TT1RiffIw71p9vIr/hmfFaxg47aCtyyFOtS8lTwh3BZKkYaXV2YZwuqZhLk3D44IPOIZcT6H3CUerrEgkVY6uiTD7iqLPG9E2XBdcjqMnAj5dGNKV99SaTs/5fBTsuwPLL6OvBtSJrBXQiCt0NzCjHhQPg5b8ujBNLWY1yOg0DcJF8b/BlkncwGqs9h5VpgzBwN/Pp6r1pU8oKXEzRLMBitzjyga4Os+1JPgvH2qZUf+rpnPsMIVZM6o+xtgpvy3QPilslBzSvXCtY/gIWrrCMtIDW1807aevfZcchYseyc5JGpVPNDY7hhFMh0X0msZYFsazRgwf4UoyKT6dZDd7PfSzu+PdMJQfISc5sOFSfRNJOJCbU3gj7zb3h6brJxustKX9fSrbUqFYT5cF7ejnNh7ZdQV3S5NVgzaCAaFQOxlpsVKlWTx/GGzBRYHL21SWT88fIDDyZ3w+CmNHfyNKYZuAzlfDHDxdv5NhIMWamzb4kBf7U4CewpApOIjjdsSKwqwrxOTRuPeqgWsKRcYu3hkxT1k/9V+Et6FGz29TiZnL3eeRL1WK6Xe4zbcRrCt9viWmkzo+XexSMB0eazYFZbh3XqYFhY0MJHLQnHMMU4RV93ejOEkGRkmUepRfBOSCds/Rv3Eh0c5EC6m8ZVlYTw=

jobs:
  include:
    - stage: *std_stage_name
      if: type IN (push, cron)
      script:
        - snyk test --peer
        - npm run tslint
      before_script: greenkeeper-lockfile-update
      after_script:
        - greenkeeper-lockfile-upload
        - snyk monitor --peer
      env:
        - LINT=1
        - SNYK_GK=1
        - CI_NG_VERSION=5
        - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
        - secure: "pOa/litDhDy+l1niY4pDtT43bzVlnFL8MppqxyX3nbZ3tmo6hpIuUWDXcS0jT62ut/F2Pj5SUyFGYhe7EiuWlpX7FfhKmkieB6lqtEgW7xIwVnjMIaMXRJxsY62swqDQ+glLsU1X9QnGJDoMMk6L1cqZnu9cZtkdBjqtgygjVxbqv4mVdm4SeFqfmFdm2147t2xrWDvnMiL/ghRp1W7QAwp4QjCAr/22UMTTDTFXT+x+dI6GNhrhiiXPlDGC+tX+ishWqjYBteCWjAOTWZH+QaANDkWaIhZLb8XHuhV11kzJ1oIgrOE7HpiN6QDXbrlNAnZa0uhsHTC7Soet88mHusnfkXt5+m3PIyydRN6dr/mfyIZvE6tZnYM6PBoYDwUOaA97nlG3HhF6BdgI1QONA/R/vIY1qw+7qjOpCxPv2AGkec/6p7vMxWQ9vBatYTzVhs2v1LVQGFb9zI3PXJhzPeY/C3B0I9IejhaibO8zRvg05bVNduvECEyTdfG1wHAWuzsvyIR60dx/X4SZI8/uslZLgq1ZVMrA5gfqW6g8NCW45OqwcbKXP5EH8/Td6Lj7fJWKnqjEI8lDicG0BCEBjzUUyVEwZf+7T2bK1yzsxaIDcvv6GjxjBa6G/qK3xABZYFt7WPoG7m3Ht1RRQ94reRk8kJed5x5IH2tQXlmhmUw="
        - secure: XZ5JBYalDUi5Bz3TUs/SXPgrmUD0OFNQYIk/t1+vkCneUDSfv+tl+dsd7Y1j52NyU1Q+6d41Pg+03ADvLC1YT5YtEV/p5WaxVY70Fj0pnKegS6Wgf6qqPEe8LEa78j6jX7CDN9SJodW6Tt5emWwB32Aw+f814tsDz9kvpNPSByWcbVsix9QvE1uM/DCMxVBbezBZ45PMdI49q/5libk7ioCIGEz0gFaOfAGQ/PHQfqk2Ua+voepLqrbo0asuIlC8EaTJNs07rpwg5lKJW3roaHtMOjKmpChq6cqatfsTUV00rInpp0bhPTkl2cFoXAPPXuKuBre6xjALKJ7bdmurlyG2ovMTUEhvdejW+nDx0/GVLatuZowxAWH/ix2m61BGS/DfSk9Mb2EJrL+4s0r6KO7IZZC4Db3j9zTQKqlLJZCsPwXBw+2f4NYRr9PX9pH9px8UqIaKeNqDu8s6aGoMDWaIQf+4uYkp2sFWS+INQCUHCZNwZ0LBHfYkK8bT4rdWFAGMLYbmSzWvhrWrQ4WVy9QoOxmXu1CZ/GFUZHR4DHnTK8sM6Gb7BK4Y6+0vWcM8vjfLaAZTCtrAyinn8tNuuu4YC2vIUP+Sraqh+k7meX1bD1InbGv54kD8bZKWlOZSuf7t69VYf1TefIBbrTqPJvfs4acF8LPPzFwrOu3igQY=
    - stage: *std_stage_name
      if: NOT type IN (push, cron)
      script: npm run tslint
      before_install: node ./ci/TravisMgr.js set-version
      env:
        - LINT=1
        - SNYK_GK=0
        - CI_NG_VERSION=5
        - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
    - <<: *std_job
      env:
        - CI_NG_VERSION=5
      script:
        - npm run build
        - npm run build:demo:aot
        - npm test
      before_script: greenkeeper-lockfile-update
    - <<: *std_job
      env:
        - CI_NG_VERSION=4
      script:
        - npm run build
        - npm test
    - <<: *npm_deploy
      env:
        - CI_NG_VERSION=5
        - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
    - <<: *npm_deploy
      env:
        - CI_NG_VERSION=4
        - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
    - stage: Deploy
      before_install: node ./ci/TravisMgr.js set-version
      env:
        - CI_NG_VERSION=5
        - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
      script: gulp site
      deploy:
        - provider: pages
          skip_cleanup: true
          on:
            tags: true
          local_dir: "./.demo"
          target_branch: gh-pages
          github_token:
            secure: VMkUx7mtTrcVIiI6AjCbVWFFZQ2+W51WoU5cvBHZ4uT84hC5il15QYmfuv752jc2bU8JrTLscqA2e5Twa40XgcaNim5Hh2eLeomHPRRcrfchPg/P41i/Kf63fpIAXFj2Il1zRA4NwtPEkw0mhSIfqdACOCahStutqfTT5ZUgxe5QVUDl/aH+rIqLfS3ZC01hPwKirHRmOZ/l4Whfb9ivaA4aSIEzN3GOO7eR2Tsd7JokyuNrSfoBZFcpJ61X0YP0VaspYVwYt75bp1noTVvx2ItWGVt2qIFiJdIAjlAjfgjkwSXJAawlrIHx5G+ajrlS6nbojmBd4s8UgNeXfIFJAG/AgDUq5uZzdklZmTkX57qrSiU9Uaq+9BYLu8I1ZNJSkieaeAy0PK0+pWBrXGAWd6rZeM5YmrqvVgrJcAST7W6HFYzLoRRmqtki5SysxpXI+ugKQgitGhGq5ES0EnwihXxuQ/xiVEjYLBFG5QviBrUZ3zc7IyfRYwCSNJ546c4XVhkwNkaBBTfz9IN4A7UscibWWd6lbO3w/tQCK+/a4D1IivRV5fnNyLw7BeoTcddWeVNHSRFupL84kE1/0jWrHs8FyMPpYyDO2jyZ9XY14iLiSiaaPIPtRQa4C7g3OEN2Nq2n1iNwmXjb0jQOPBkTBYCFdzkXJcoLagIz51EaHS4=
        - provider: releases
          skip_cleanup: true
          api_key:
            secure: VMkUx7mtTrcVIiI6AjCbVWFFZQ2+W51WoU5cvBHZ4uT84hC5il15QYmfuv752jc2bU8JrTLscqA2e5Twa40XgcaNim5Hh2eLeomHPRRcrfchPg/P41i/Kf63fpIAXFj2Il1zRA4NwtPEkw0mhSIfqdACOCahStutqfTT5ZUgxe5QVUDl/aH+rIqLfS3ZC01hPwKirHRmOZ/l4Whfb9ivaA4aSIEzN3GOO7eR2Tsd7JokyuNrSfoBZFcpJ61X0YP0VaspYVwYt75bp1noTVvx2ItWGVt2qIFiJdIAjlAjfgjkwSXJAawlrIHx5G+ajrlS6nbojmBd4s8UgNeXfIFJAG/AgDUq5uZzdklZmTkX57qrSiU9Uaq+9BYLu8I1ZNJSkieaeAy0PK0+pWBrXGAWd6rZeM5YmrqvVgrJcAST7W6HFYzLoRRmqtki5SysxpXI+ugKQgitGhGq5ES0EnwihXxuQ/xiVEjYLBFG5QviBrUZ3zc7IyfRYwCSNJ546c4XVhkwNkaBBTfz9IN4A7UscibWWd6lbO3w/tQCK+/a4D1IivRV5fnNyLw7BeoTcddWeVNHSRFupL84kE1/0jWrHs8FyMPpYyDO2jyZ9XY14iLiSiaaPIPtRQa4C7g3OEN2Nq2n1iNwmXjb0jQOPBkTBYCFdzkXJcoLagIz51EaHS4=
          on:
            tags: true
          file: documentation.tar.gz
